#!/usr/bin/perl

use LWP::Simple;
use Time::Local;
use POSIX;

$content = get("https://ipinfo.io");

die "Unable to get IP info" unless defined $content;

($city, $lat, $lon) =
  ($content =~ m/.*"city":\s+"([^"]+)".*"loc":\s+"(-?[0-9.]+),(-?[0-9.]+).*"/ims);

$content = get(
  "https://api.sunrise-sunset.org/json?lat=$lat&lng=$lon&formatted=0");

die "Unable to get sunrise/sunset data" unless defined $content;

$sunrise_str=$content;
$sunset_str=$content;
$sunrise_str =~ s#.*"sunrise":"([^"]*)".*#\1#;
$sunset_str =~ s#.*"sunset":"([^"]*)".*#\1#;
$current_str=strftime "%Y-%m-%dT%H:%M:%S+00:00", gmtime();

$content = get(
  "https://tgftp.nws.noaa.gov/data/observations/metar/decoded/KLMO.TXT");

die "Unable to get weather data" unless defined $content;

$sky_conditions = $content;
$sky_conditions =~ s#.*Sky conditions:\s+([^\n]+).*#\1#ims;
$sky_conditions =~ s#\s#_#g;

$wind = $content;
$wind =~ s#.*Wind:\s+([^\n]+).*#\1#ims;
($wind_direction, $wind_speed) =
    ($wind =~ m/from the ([A-Z]+).*at (\d+) MPH.*/g);


$temp = $content;
$temp =~ s#.*Temperature:\s+(-?[0-9.]+) F.*#\1#ims;

if ($current_str gt $sunrise_str and $current_str lt $sunset_str) {
  $is_day = 1;
} else {
  $is_day = 0;
}

%directions = (
  NE => "ï•",
  NNE => "ï•",
  ENE => "ï•",
  SE => "ï•š",
  SSE => "ï•š",
  ESE => "ï•š",
  NW => "ï•‚",
  NNW => "ï•‚",
  WNW => "ï•‚",
  SW => "ï•›",
  SSW => "ï•›",
  WSW => "ï•›",
  N => "ï•„",
  S => "ï•œ",
  W => "ï•“",
  E => "ï•Œ" );

$dir=%directions{$wind_direction};

%conditions_day = (
  clear => "<fc=#ddcf04>îŒ",
  sunny => "<fc=#ddcf04>îŒ",
  mostly_clear => "<fc=#00a3c4>îˆ¦",
  mostly_sunny => "<fc=#ddcf04>îŒŒ",
  partly_sunny => "<fc=#ddcf04>îŒŒ",
  fair => "<fc=#a0a0a0>ðŸŒ‘",
  cloudy =>"<fc=#a0a0a0>ïª",
  overcast =>"<fc=#808080>ï™ž",
  partly_cloudy => "<fc=#a0a0a0>ïª”",
  mostly_cloudy => "<fc=#808080>ï™ž",
  considerable_cloudiness => "<fc=#a0a0a0>ï­½" );

%conditions_night = (
  clear => "<fc=#00a3c4>ï††",
  sunny => "<fc=#00a3c4>ï††",
  mostly_clear => "<fc=#00a3c4>îˆ¦",
  mostly_sunny => "<fc=#00a3c4>îˆ¦",
  partly_sunny => "<fc=#00a3c4>îˆ¦",
  fair => "<fc=#808080>ðŸŒ‘",
  cloudy =>"<fc=#808080>ïª",
  overcast =>"<fc=#404040>ï™ž",
  partly_cloudy => "<fc=#a0a0a0>îˆ¦",
  mostly_cloudy => "<fc=#808080>ï™ž",
  considerable_cloudiness => "<fc=#a0a0a0>ï­½" );

if ($is_day) {
  $conditions = %conditions_day{$sky_conditions};
} else {
  $conditions = %conditions_night{$sky_conditions};  
}

printf("<fc=#a0a0a0><fn=3>$city</fn> <fn=3>$dir</fn> <fn=3>${wind_speed}</fn></fc> $conditions</fc><fn=3>   <fc=#a0a0a0>%.0fÂ°F</fc></fn>\n", $temp);
